<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <link rel="shortcut icon" type="image/x-icon" href="assets/imgs/theme/favicon.svg">
  <link href="assets/css/style.css?v=1.0.0" rel="stylesheet">
  <title>ibest - Wholesale Buyers</title>
</head>

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <link rel="shortcut icon" type="image/x-icon" href="assets/imgs/theme/favicon.svg">
  <link href="assets/css/style.css?v=1.0.0" rel="stylesheet">
  <title>ibest - Sellet List</title>
</head>

<body>
  <div id="preloader-active">
    <div class="preloader d-flex align-items-center justify-content-center">
      <div class="preloader-inner position-relative">
        <div class="text-center"><img class="mb-10" src="assets/imgs/theme/favicon.svg" alt="ibest">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="screen-overlay"></div>
  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top"><a class="brand-wrap" href="page-dashboard.html"><img class="logo"
          src="assets/imgs/theme/favicon.svg" alt="Evara Dashboard"></a>
      <div>
        <button class="btn btn-icon btn-aside-minimize"><i class="text-muted material-icons md-menu_open"></i></button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item"><a class="menu-link" href="page-dashboard.html"><i
              class="icon material-icons md-home"></i><span class="text">Dashboard</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-products-list.html"><i
              class="icon material-icons md-shopping_bag"></i><span class="text">Products</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-orders.html"><i
              class="icon material-icons md-shopping_cart"></i><span class="text">Orders</span></a></li>
        <li class="menu-item active"><a class="menu-link" href="page-sellers-list.html"><i
              class="icon material-icons md-store"></i><span class="text">Wholesellers</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-account-register.html"><i
              class="icon material-icons md-person"></i><span class="text">Create Moderator</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-reviews.html"><i
              class="icon material-icons md-comment"></i><span class="text">Reviews</span></a></li>
      </ul>
      <hr>
      <ul class="menu-aside">
        <li class="menu-item"><a class="menu-link" href="page-error-404.html"><i
              class="icon material-icons md-settings"></i><span class="text">Settings</span></a></li>
      </ul>
    </nav>
  </aside>
  <main class="main-wrap">
    <header class="main-header navbar">
      <div class="col-search"></div>
      <div class="col-nav">
        <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"><i
            class="material-icons md-apps"></i></button>
        <ul class="nav">
          <li class="nav-item"><a class="nav-link btn-icon" href="#"><i
                class="material-icons md-notifications animation-shake"></i><span class="badge rounded-pill"
                id="notification-badge">0</span></a></li>
          <li class="nav-item"><a class="nav-link btn-icon darkmode" href="#"><i
                class="material-icons md-nights_stay"></i></a></li>
          <li class="nav-item"><a class="requestfullscreen nav-link btn-icon" href="#"><i
                class="material-icons md-cast"></i></a></li>
          <li class="nav-item"><a class="dropdown-toggle" id="dropdownAccount" data-bs-toggle="dropdown" href="#"
              aria-expanded="false"><img class="img-xs rounded-circle" src="assets/imgs/people/avatar2.jpg"
                alt="User"></a>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
              <a class="dropdown-item text-danger" onclick="adminOutUser()"><i
                  class="material-icons md-exit_to_app"></i>Logout</a>
            </div>
          </li>
        </ul>
      </div>
    </header>
    <section class="content-main">
      <div class="content-header">
        <h2 class="content-title">Wholesale Users</h2>
        <!--<div><a class="btn btn-primary" href="#"><i class="material-icons md-plus"></i> Create new</a></div>-->
      </div>
      <div class="card mb-4">
        <header class="card-header">
          <div class="row gx-3">
            <div class="col-lg-4 col-md-6 me-auto">
              <input class="form-control" type="text" id="searchInput" placeholder="Search by Name"
                oninput="searchUsers()">
            </div>
            <div class="col-lg-2 col-6 col-md-3" id="filter_status">
              <select class="form-select">
                <option selected="active">Show All</option>
                <option>Approved</option>
                <option>Declined</option>
                <option>No action taken</option>
              </select>
            </div>
            <!--<div class="col-lg-2 col-md-3 col-6">
                <select class="form-select">
                  <option>Show 20</option>
                  <option>Show 30</option>
                  <option>Show 40</option>
                </select>
              </div>-->
          </div>
        </header>
        <!-- card-header end//-->
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Buyer</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th>Registered</th>
                  <th class="text-end"> Action</th>
                </tr>
              </thead>
              <tbody>
                <!--User list will show here dynamically-->
              </tbody>
            </table>
            <!-- table-responsive.//-->
            <!-- card-body end//-->
          </div>
        </div>
      </div>
      <!-- card end//-->
      <div class="pagination-area mt-30 mb-50 d-flex justify-content-center">
        <nav aria-label="Page navigation example">
          <ul class="pagination justify-content-start">
            <li class="page-item"><a class="page-link" href="#"><i class="material-icons md-chevron_left"></i></a></li>
            <!--Page number will dsiplay here-->
            <li class="page-item"><a class="page-link" href="#"><i class="material-icons md-chevron_right"></i></a></li>
          </ul>
        </nav>
      </div>
    </section>
    <footer class="main-footer font-xs">
      <div class="row pb-30 pt-15">
        <div class="col-sm-6">
          <script>document.write(new Date().getFullYear())</script> &copy;, ibest .
        </div>
        <div class="col-sm-6">
          <div class="text-sm-end">All rights reserved</div>
        </div>
      </div>
    </footer>

    <!-- Order Detail Modal -->
    <div class="modal fade" id="userDetailModal" tabindex="-1" aria-labelledby="userDetailModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" id="userDetailModalLabel">Order Detail</h3>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="userDetailModalBody">
            <!-- Order details will be dynamically inserted here -->
          </div>
          <div class="modal-footer d-flex justify-content-center">
            <button type="button" class="btn btn-light-model rounded" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit status Model -->
    <div class="modal fade" id="editStatusModal" tabindex="-1" aria-labelledby="editStatustModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" id="editStatusModalLabel">Edit Status</h3>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editProductForm">
              <div class="mb-4">
                <label class="form-label" for="user_status">Status</label>
                <select class="form-select" id="user_status">
                  <option value="Approved">Approved</option>
                  <option value="Declined">Declined</option>
                  <option value="No action taken">No action taken</option>
                </select>
              </div>

              <!-- Add more input fields for other product details -->
            </form>
          </div>
          <div class="modal-footer d-flex justify-content-center">
            <button type="button" class="btn btn-light-model rounded" id="saveOrderChanges">Save changes</button>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script src="assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="assets/js/vendors/bootstrap.bundle.min.js"></script>
  <script src="assets/js/vendors/select2.min.js"></script>
  <script src="assets/js/vendors/perfect-scrollbar.js"></script>
  <script src="assets/js/vendors/jquery.fullscreen.min.js"></script>
  <script src="assets/js/vendors/chart.js"></script>
  <script src="assets/js/main.js?v=1.0.0"></script>
  <script src="assets/js/custom-chart.js" type="text/javascript"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAKUrhFJiaHhFlqu0w3zKTyhIgXJNIIg68",
      authDomain: "ibest-ba2cf.firebaseapp.com",
      projectId: "ibest-ba2cf",
      storageBucket: "ibest-ba2cf.appspot.com",
      messagingSenderId: "946876798909",
      appId: "1:946876798909:web:b40bc879e556a26cafe4d4",
      measurementId: "G-QYR88B09WG"
    };
    firebase.initializeApp(firebaseConfig);

    var firestore = firebase.firestore();
    var auth = firebase.auth();
    var storage = firebase.storage();
    var storageRef = storage.ref();
    var docId = {};

    function setupPagination() {
      const rowsPerPage = 3;
      let currentPage = 1;

      const tableRows = document.querySelectorAll('.table tbody tr');

      // Function to calculate the total number of pages
      function calculateTotalPages() {
        return Math.ceil(tableRows.length / rowsPerPage);
      }

      // Function to update pagination HTML
      function updatePagination(totalPages) {
        const paginationList = document.querySelector('.pagination');
        paginationList.innerHTML = ''; // Clear existing pagination

        // Left pagination button
        const leftButton = createPaginationButton('md-chevron_left');
        leftButton.addEventListener('click', () => goToPreviousPage());
        paginationList.appendChild(leftButton);

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          const listItem = document.createElement('li');
          listItem.classList.add('page-item');
          if (i === currentPage) {
            listItem.classList.add('active');
          }
          const link = document.createElement('a');
          link.classList.add('page-link');
          link.href = '#';
          link.textContent = i;
          link.addEventListener('click', () => goToPage(i));
          listItem.appendChild(link);
          paginationList.appendChild(listItem);
        }

        // Right pagination button
        const rightButton = createPaginationButton('md-chevron_right');
        rightButton.addEventListener('click', () => goToNextPage());
        paginationList.appendChild(rightButton);
      }

      // Function to create pagination button
      function createPaginationButton(iconClass) {
        const button = document.createElement('li');
        button.classList.add('page-item');
        const link = document.createElement('a');
        link.classList.add('page-link');
        link.href = '#';
        link.innerHTML = `<i class="material-icons ${iconClass}"></i>`;
        button.appendChild(link);
        return button;
      }

      // Function to show rows for the given page
      function showRowsForPage(pageNumber) {
        const startIndex = (pageNumber - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;

        tableRows.forEach((row, index) => {
          if (index >= startIndex && index < endIndex) {
            row.style.display = 'table-row';
          } else {
            row.style.display = 'none';
          }
        });
      }

      // Function to go to the previous page
      function goToPreviousPage() {
        if (currentPage > 1) {
          currentPage--;
          updatePagination(calculateTotalPages());
          showRowsForPage(currentPage);
        }
      }

      // Function to go to the next page
      function goToNextPage() {
        if (currentPage < calculateTotalPages()) {
          currentPage++;
          updatePagination(calculateTotalPages());
          showRowsForPage(currentPage);
        }
      }

      // Function to go to a specific page
      function goToPage(pageNumber) {
        currentPage = pageNumber;
        updatePagination(calculateTotalPages());
        showRowsForPage(currentPage);
      }

      // Initial setup
      const totalPages = calculateTotalPages();
      updatePagination(totalPages);
      showRowsForPage(currentPage);
    }

    async function populateFilters() {
      const searchInput = document.getElementById('searchInput').value.trim().toLowerCase();
      fetchUsers('Show All', searchInput)
        .then(() => {
          setupPagination();
        })
        .catch((error) => {
          console.error('Error fetching and displaying orders:', error);
        });

      // Get the <select> element
      const selectElementStatus = document.querySelector('#filter_status');

      // Add event listener for change event
      selectElementStatus.addEventListener('change', function (event) {
        // Get the selected value
        const selectedStatus = event.target.value;
        const searchInput = document.getElementById('searchInput').value.trim().toLowerCase();
        fetchUsers(selectedStatus, searchInput)
          .then(() => {
            setupPagination();
          })
          .catch((error) => {
            console.error('Error fetching and displaying products:', error);
          });
      });
    }

    // Call function when the page loads
    populateFilters();

    function searchUsers() {
      const searchInput = document.getElementById('searchInput').value.trim().toLowerCase();
      const status = document.querySelector('#filter_status select').value; // Get the selected status filter
      fetchUsers(status, searchInput);
    }


    function fetchUsers(status, searchQuery) {
      return new Promise((resolve, reject) => {
        const userCollectionRef = firebase.firestore().collection('users');

        userCollectionRef.get().then((querySnapshot) => {
          const tbody = document.querySelector('tbody');
          tbody.innerHTML = ''; // Clear existing table rows

          querySnapshot.forEach((doc) => {
            const userData = doc.data();
            const date = new Date(userData.registeredDate.seconds * 1000 + userData.registeredDate.nanoseconds / 1000000);
            const formattedDate = `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}`;

            if ((userData.wholesaleBuyer === true) &&
              (status === 'Show All' || userData.status === status) &&
              (searchQuery === '' ||
                userData.Name.toLowerCase().includes(searchQuery) ||
                doc.id.toLowerCase().includes(searchQuery))) {
              showUser();
            }

            function showUser() {
              const userRow = `
                   <tr class="align-items-center">
                     <td width="40%">
                     <div class="itemside">
                      <div class="left">
                        ${userData.imageUrl ? `<img class="img-sm img-avatar" src="${userData.imageUrl}" alt="Userpic">` : `<i class="icon material-icons md-person"></i>`}
                      </div>
                        <div class="info pl-3">
                          <h6 class="mb-0 title">${userData.Name}</h6>
                        <small class="text-muted">User ID: ${doc.id}</small>
                      </div>
                     </div>
                   </td>
                   <td>${userData.Email}</td>
                 <td><span class="badge rounded-pill ${getBadgeClass(userData.status)}">${userData.status}</span></td>
                  <td>${formattedDate}</td>
                  <td class="text-end">
                    <a class="btn btn-md rounded font-sm" onclick="userDetail('${doc.id}')">View details</a>
                    <div class="dropdown">
                      <a class="btn btn-light rounded btn-sm font-sm" href="#" data-bs-toggle="dropdown">
                        <i class="material-icons md-more_horiz"></i>
                      </a>
                      <div class="dropdown-menu">
                        <a class="dropdown-item" onclick="userDetail('${doc.id}')">View details</a>
                        <a class="dropdown-item" onclick="editStatus('${doc.id}')">Edit Status</a>
                      </div>
                    </div>
                  </td>
               </tr>
            `;
              tbody.insertAdjacentHTML('beforeend', userRow);
            }

          });

          resolve(); // Resolve the promise after populating the table
        }).catch((error) => {
          reject(error); // Reject the promise if there's an error
        });
      });
    }

    function userDetail(docID) {
      const userCollectionRef = firebase.firestore().collection('users').doc(docID);
      userCollectionRef.get()
        .then((doc) => {
          if (doc.exists) {
            // Data exists, you can access it using doc.data()
            const data = doc.data();
            // Access the modal body element
            const modalBody = document.getElementById('userDetailModalBody');
            const date = new Date(data.registeredDate.seconds * 1000 + data.registeredDate.nanoseconds / 1000000);
            const formattedDate = `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}`;
            // Generate HTML content for the order details
            const userDetailsHTML = `
                      <p><strong>Name:</strong> ${data.Name}</p>
                      <p><strong>Email:</strong> ${data.Email}</p>
                      <p><strong>User ID:</strong> ${doc.id}</p>
                      <p><strong>Status:</strong> ${data.status}</p>
                      <p><strong>Registered Date:</strong> ${formattedDate}</p>
                      <!-- Add more order details as needed -->
                    `;

            // Set the HTML content of the modal body
            modalBody.innerHTML = userDetailsHTML;

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('userDetailModal'));
            modal.show();

          } else {
            console.log('No such document!');
          }
        })
        .catch((error) => {
          console.log('Error getting document:', error);
        });
    }

    function editStatus(docID) {
      docId = docID;
      const userCollectionRef = firebase.firestore().collection('users').doc(docID);
      userCollectionRef.get().then((doc) => {
        if (doc.exists) {
          const data = doc.data();
          const selectElement = document.getElementById('user_status');
          const option1 = selectElement.options[0];//Approved
          const option2 = selectElement.options[1];//Declined
          const option3 = selectElement.options[2];//No action taken
          console.log("Status:", data.status);
          if (data.status === 'Approved') {
            option1.selected = true;
          } else if (data.status === 'Declined') {
            option2.selected = true;
          } else if (data.status === 'No action taken') {
            option3.selected = true;
          }
        } else {
          console.log('No such document!');
        }
      }).catch((error) => {
        console.log('Error getting document:', error);
      });

      // Show the modal
      var myModal = new bootstrap.Modal(document.getElementById('editStatusModal'));
      myModal.show();
    }


    // Add event listener to the Save Changes button
    document.getElementById('saveOrderChanges').addEventListener('click', function () {
      $('#editStatusModal').modal('hide');

      const userCollectionRef = firebase.firestore().collection('users').doc(docId);

      const newStatus = document.getElementById('user_status').value;

      // Update the status field in Firestore
      userCollectionRef.update({
        status: newStatus
      })
        .then(() => {
          console.log('User status updated successfully');
          alert('User status updated successfully');
          window.location.href = "page-sellers-list.html";
        })
        .catch((error) => {
          console.error('Error updating user status:', error);
        });
    });



    // Helper function to get the appropriate badge class based on user status
    function getBadgeClass(status) {
      switch (status) {
        case 'Approved':
          return 'alert-success';
        case 'Declined':
          return 'alert-danger';
        case 'No action taken':
          return 'alert-warning';
        default:
          return '';
      }
    }


    var count = 0;

    function fetchOrders() {
      const ordersCollectionRef = firebase.firestore().collection('users');
      ordersCollectionRef.get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          userData.orders.forEach((order) => {
            if (order.viewed === false) {
              count++;
            }
          });
        });
        var badge = document.getElementById("notification-badge");
        badge.textContent = count;
      }).catch((error) => {
        console.log("Error fetching order notification.");
      });
    }

    fetchOrders();

    // Function to sign out the admin
    function adminOutUser() {
      firebase.auth().signOut().then(function () {
        console.log('admin signed out successfully');
        alert('Admin signed out successfully!');
        window.location.href = 'index.html';
      }).catch(function (error) {
        console.error('Error signing out:', error);
      });
    }

  </script>
</body>

</html>
