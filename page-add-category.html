<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <link rel="shortcut icon" type="image/x-icon" href="assets/imgs/theme/favicon.svg">
  <link href="assets/css/style.css?v=1.0.0" rel="stylesheet">
  <title>ibest - Add Category</title>
</head>

<body>
  <div id="preloader-active">
    <div class="preloader d-flex align-items-center justify-content-center">
      <div class="preloader-inner position-relative">
        <div class="text-center"><img class="mb-10" src="assets/imgs/theme/favicon.svg" alt="ibest">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="screen-overlay"></div>
  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top"><a class="brand-wrap" href="page-dashboard.html"><img class="logo"
          src="assets/imgs/theme/favicon.svg" alt="Evara Dashboard"></a>
      <div>
        <button class="btn btn-icon btn-aside-minimize"><i class="text-muted material-icons md-menu_open"></i></button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item"><a class="menu-link" href="page-dashboard.html"><i
              class="icon material-icons md-home"></i><span class="text">Dashboard</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-products-list.html"><i
              class="icon material-icons md-shopping_bag"></i><span class="text">Products</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-orders.html"><i
              class="icon material-icons md-shopping_cart"></i><span class="text">Orders</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-sellers-list.html"><i
              class="icon material-icons md-store"></i><span class="text">Wholesellers</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-account-register.html"><i
              class="icon material-icons md-person"></i><span class="text">Create Moderator</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-reviews.html"><i
              class="icon material-icons md-comment"></i><span class="text">Reviews</span></a></li>
      </ul>
      <hr>
      <ul class="menu-aside">
        <li class="menu-item"><a class="menu-link" href="page-error-404.html"><i
              class="icon material-icons md-settings"></i><span class="text">Settings</span></a></li>
      </ul>
    </nav>
  </aside>
  <main class="main-wrap">
    <header class="main-header navbar">
      <div class="col-search"></div>
      <div class="col-nav">
        <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"><i
            class="material-icons md-apps"></i></button>
        <ul class="nav">
          <li class="nav-item"><a class="nav-link btn-icon" href="#"><i
                class="material-icons md-notifications animation-shake"></i><span class="badge rounded-pill"
                id="notification-badge">0</span></a></li>
          <li class="nav-item"><a class="nav-link btn-icon darkmode" href="#"><i
                class="material-icons md-nights_stay"></i></a></li>
          <li class="nav-item"><a class="requestfullscreen nav-link btn-icon" href="#"><i
                class="material-icons md-cast"></i></a></li>
          <li class="nav-item"><a class="dropdown-toggle" id="dropdownAccount" data-bs-toggle="dropdown" href="#"
              aria-expanded="false"><img class="img-xs rounded-circle" src="assets/imgs/people/avatar2.jpg"
                alt="User"></a>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
              <a class="dropdown-item text-danger" onclick="adminOutUser()"><i
                  class="material-icons md-exit_to_app"></i>Logout</a>
            </div>
          </li>
        </ul>
      </div>
    </header>
    <section class="content-main">
      <div class="row">
        <div class="col-9">
          <div class="content-header">
            <div>
              <h2 class="content-title card-title">Category</h2>
              <p>Add, edit or delete a category.</p>
            </div>
            <div><a onclick="save()" class="btn btn-light rounded font-sm mr-5 text-body hover-up">Save</a></div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card mb-4">
            <div class="card-header">
              <h4>Add Categories</h4>
            </div>
            <div class="card-body">
              <div class="category-section" id="categorySection">
                <!-- Initially show category and sub-category input fields -->
                <div class="mb-4">
                  <label class="form-label" for="product_category">Category</label>
                  <input class="form-control" id="product_category" type="text" placeholder="Type here">
                </div>
                <div class="mb-4">
                  <label class="form-label" for="product_sub">Sub-Category</label>
                  <input class="form-control" id="product_sub" type="text" placeholder="Type here">
                </div>
                <div class="mb-4">
                  <button class="btn btn-secondary mt-2" onclick="addSubCategory()">Add Sub-Category</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-header">
              <h4>Delete Category</h4>
            </div>
            <div class="card-body">
              <div class="category-section">
                <div class="mb-4">
                  <label class="form-label">Category</label>
                  <select class="form-select" id="categorySelect">
                    <!--Category option will show here dynamically-->
                  </select>
                </div>
                <div class="mb-4">
                  <label class="form-label">Sub-category</label>
                  <select class="form-select" id="subCategorySelect">
                    <!-- Sub-Category option will show here dynamically-->
                  </select>
                </div>
                <div class="mb-4">
                  <button class="btn btn-secondary mt-2" onclick="confirmDeletion()">Delete Category</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-3">
          <div class="card mb-4">
            <div class="card-header">
              <h4>Media</h4>
            </div>
            <div class="card-body">
              <div class="input-upload"><img src="assets/imgs/theme/upload.svg" alt="">
                <input class="form-control" type="file">
              </div>
            </div>
          </div>
          <!--<div class="card mb-4">
            <div class="card-header">
              <h4>Delete Category</h4>
            </div>
            <div class="card-body">
              <div class="row gx-2">
                <div class="col-sm-6 mb-3">
                  <label class="form-label">Category</label>
                  <select class="form-select">
                    <option> Automobiles</option>
                    <option> Home items</option>
                    <option> Electronics</option>
                    <option> Smartphones</option>
                    <option> Sport items</option>
                    <option> Baby and Tous</option>
                  </select>
                </div>
                <div class="col-sm-6 mb-3">
                  <label class="form-label">Sub-category</label>
                  <select class="form-select">
                    <option> Nissan</option>
                    <option> Honda</option>
                    <option> Mercedes</option>
                    <option> Chevrolet</option>
                  </select>
                </div>
              </div>
            </div>
          </div>-->
        </div>
      </div>
    </section>
    <footer class="main-footer font-xs">
      <div class="row pb-30 pt-15">
        <div class="col-sm-6">
          <script>document.write(new Date().getFullYear())</script> &copy;, ibest.
        </div>
        <div class="col-sm-6">
          <div class="text-sm-end">All rights reserved</div>
        </div>
      </div>
    </footer>

    <!-- Delete Confirm Modal -->
    <div class="modal fade" id="deleteOrderModal" tabindex="-1" aria-labelledby="deleteOrderModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" id="deleteOrderModalLabel">Delete Category</h3>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body d-flex justify-content-center">
            <h4 class="content-title card-title">Are you sure you want to delete category? The products in this Category
              or Sub-Category will also deleted.</h4>
          </div>
          <div class="modal-footer d-flex justify-content-center">
            <button type="button" class="btn btn-primary rounded" id="confirmDelete">Yes</button>
            <button type="button" class="btn btn-light-model rounded" data-bs-dismiss="modal">No</button>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="assets/js/vendors/bootstrap.bundle.min.js"></script>
  <script src="assets/js/vendors/select2.min.js"></script>
  <script src="assets/js/vendors/perfect-scrollbar.js"></script>
  <script src="assets/js/vendors/jquery.fullscreen.min.js"></script>
  <script src="assets/js/vendors/chart.js"></script>
  <script src="assets/js/main.js?v=1.0.0"></script>
  <script src="assets/js/custom-chart.js" type="text/javascript"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAKUrhFJiaHhFlqu0w3zKTyhIgXJNIIg68",
      authDomain: "ibest-ba2cf.firebaseapp.com",
      projectId: "ibest-ba2cf",
      storageBucket: "ibest-ba2cf.appspot.com",
      messagingSenderId: "946876798909",
      appId: "1:946876798909:web:b40bc879e556a26cafe4d4",
      measurementId: "G-QYR88B09WG"
    };
    firebase.initializeApp(firebaseConfig);

    var firestore = firebase.firestore();
    var auth = firebase.auth();
    let deletedDocIds = [];

    // Function to fetch categories and sub-categories from Firestore
    async function fetchCategoriesAndSubCategories() {
      try {
        const categoriesSnapshot = await firestore.collection('categories').get();

        const categories = {};
        categoriesSnapshot.forEach(categoryDoc => {
          const categoryName = categoryDoc.id;
          const subCategories = categoryDoc.data().subCategories;
          categories[categoryName] = subCategories;
        });

        return categories;
      } catch (error) {
        console.error("Error fetching categories and sub-categories:", error);
        return {};
      }
    }

    // Function to populate category select element
    async function populateCategorySelect() {
      const categorySelect = document.getElementById('categorySelect');
      const categories = await fetchCategoriesAndSubCategories();

      // Clear existing options
      categorySelect.innerHTML = '';

      // Populate with fetched categories
      for (const categoryName in categories) {
        const option = document.createElement('option');
        option.value = categoryName;
        option.text = categoryName;
        categorySelect.add(option);
      }

      // Trigger change event to populate sub-categories for the initial selected category
      categorySelect.dispatchEvent(new Event('change'));
    }

    // Function to populate sub-category select based on the selected category
    async function populateSubCategories() {
      const categorySelect = document.getElementById('categorySelect');
      const subCategorySelect = document.getElementById('subCategorySelect');
      const selectedCategory = categorySelect.value;
      const categories = await fetchCategoriesAndSubCategories();

      // Clear existing options
      subCategorySelect.innerHTML = '';

      // Populate with sub-categories for the selected category
      categories[selectedCategory].forEach(subCategory => {
        const option = document.createElement('option');
        option.text = subCategory;
        subCategorySelect.add(option);
      });
    }

    // Listen for changes in the category select element
    document.getElementById('categorySelect').addEventListener('change', populateSubCategories);
    populateCategorySelect();

    function confirmDeletion() {
      // Show the modal
      var myModal = new bootstrap.Modal(document.getElementById('deleteOrderModal'));
      myModal.show();
    }

    // Attach the event listener outside of the confirmDeletion function
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    confirmDeleteBtn.addEventListener('click', function () {
      deleteCategory();

      // Close the modal
      $('#deleteOrderModal').modal('hide');
    });

    function deleteCategory() {
      const categorySelect = document.getElementById('categorySelect').value;
      const subCategorySelect = document.getElementById('subCategorySelect').value;

      console.log("Category:", categorySelect);
      console.log("subCategory:", subCategorySelect);

      // Array to store deleted document IDs
      const collectionRef = firestore.collection('products').doc(categorySelect).collection(subCategorySelect);
      deleteSubCategoryDocs(collectionRef)
        .then(() => {
          console.log("All documents deleted successfully!");

          const collectionRef = firestore.collection('products').doc(categorySelect).collection('All');
          collectionRef.get()
            .then((querySnapshot) => {
              querySnapshot.forEach((doc) => {
                if (deletedDocIds.includes(doc.id)) {
                  const deletionPromise = doc.ref.delete();
                }
              })
            })
            .catch((error) => {
              reject(error);
            });

          const categoryColRef = firestore.collection('categories').doc(categorySelect);

          categoryColRef.get().then((doc) => {
            if (doc.exists) {
              let subCategories = doc.data().subCategories;
              let productsNo = doc.data().ProductsNo - deletedDocIds.length;

              const index = subCategories.indexOf(subCategorySelect);
              if (index !== -1) {
                subCategories.splice(index, 1);
              } else {
                console.log("Selected subcategory not found in the array.");
                return;
              }

              // Check if the length of subCategories is 1
              if (doc.data().subCategories.length === 1) {
                // Delete the document if there's only one subcategory left
                categoryColRef.delete().then(() => {
                  console.log("Document deleted as it had only one subcategory.");
                }).catch((error) => {
                  console.error("Error deleting category document:", error);
                });
              } else {
                // Update the document with the modified array and updated ProductsNo
                categoryColRef.update({
                  subCategories: subCategories,
                  ProductsNo: productsNo
                }).then(() => {
                  console.log("Selected sub-category removed from the array and ProductsNo updated successfully!");
                }).catch((error) => {
                  console.error("Error updating category document:", error);
                });
              }
            } else {
              console.log("No such document exists for the specified category.");
            }
          }).catch((error) => {
            console.error("Error getting category document:", error);
          });
        })
        .catch((error) => {
          console.error("Error deleting documents: ", error);
        });
    }

    // Function to delete documents (from selected sub-cateory) and resolve when all documents are deleted
    function deleteSubCategoryDocs(collectionRef) {
      return new Promise((resolve, reject) => {
        collectionRef.get()
          .then((querySnapshot) => {
            const deletionPromises = [];
            querySnapshot.forEach((doc) => {
              // Push the ID of the document to the array
              deletedDocIds.push(doc.id);

              // Delete the document and add the promise to the array
              const deletionPromise = doc.ref.delete();
              deletionPromises.push(deletionPromise);
            });

            // Wait for all deletion promises to resolve
            Promise.all(deletionPromises)
              .then(() => {
                resolve();
              })
              .catch((error) => {
                reject(error);
              });
          })
          .catch((error) => {
            reject(error);
          });
      });
    }


    // Function to add input fields for sub-categories
    function addSubCategory() {
      var subCategoryInput = document.createElement('input');
      subCategoryInput.className = 'form-control';
      subCategoryInput.type = 'text';
      subCategoryInput.placeholder = 'Type here';
      var subCategorySection = document.querySelectorAll('.category-section .mb-4')[1];
      subCategorySection.appendChild(subCategoryInput);
    }


    // Function to save the data and show it on console
    function save() {
      var categoryValue = document.getElementById('product_category').value;
      var subCategories = [];
      var subCategoryInputs = document.querySelectorAll('.category-section .mb-4 input[type="text"]');


      for (var i = 1; i < subCategoryInputs.length; i++) {
        var inputValue = subCategoryInputs[i].value.trim();

        if (inputValue !== '' && inputValue !== null) {
          subCategories.push(inputValue);
        }
      }

      if (!categoryValue) {
        alert("Please enter the Category.");
        return;
      }

      if (subCategories.length === 0) {
        alert("Please enter at least one Sub-Category.");
        return;
      }

      console.log("Category:", categoryValue);
      console.log("Sub-Categories:", subCategories);

      var fileInput = document.querySelector('input[type="file"]');
      var file = fileInput.files[0];

      var storage = firebase.storage();
      var storageRef = storage.ref();
      var uploadTask = storageRef.child('images/' + categoryValue).put(file);

      uploadTask.on('state_changed',
        function (snapshot) {
          // Handle progress
        },
        function (error) {
          console.error("Error uploading image: ", error);
        },
        function () {
          console.log("Image uploaded successfully!");

          uploadTask.snapshot.ref.getDownloadURL().then(function (downloadURL) {
            firestore.collection("categories").doc(categoryValue).set({
              subCategories: subCategories,
              ProductsNo: "0",
              imageURL: downloadURL
            })
              .then(function () {
                console.log("Category document successfully written!");
              })
              .catch(function (error) {
                console.error("Error writing category document: ", error);
              });
          });
        }
      );
    }

    var count = 0;

    function fetchOrders() {
      const ordersCollectionRef = firebase.firestore().collection('users');
      ordersCollectionRef.get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          userData.orders.forEach((order) => {
            if (order.viewed === false) {
              count++;
            }
          });
        });
        var badge = document.getElementById("notification-badge");
        badge.textContent = count;
      }).catch((error) => {
        console.log("Error fetching order notification.");
      });
    }

    fetchOrders();

    // Function to sign out the admin
    function adminOutUser() {
      firebase.auth().signOut().then(function () {
        console.log('admin signed out successfully');
        alert('Admin signed out successfully!');
        window.location.href = 'index.html';
      }).catch(function (error) {
        console.error('Error signing out:', error);
      });
    }

  </script>
</body>

</html>
