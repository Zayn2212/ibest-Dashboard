<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <link rel="shortcut icon" type="image/x-icon" href="assets/imgs/theme/favicon.svg">
  <link href="assets/css/style.css?v=1.0.0" rel="stylesheet">
  <title>ibest - Add Product</title>
</head>


<body>
  <div id="preloader-active">
    <div class="preloader d-flex align-items-center justify-content-center">
      <div class="preloader-inner position-relative">
        <div class="text-center"><img class="mb-10" src="assets/imgs/theme/favicon.svg" alt="ibest">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="screen-overlay"></div>
  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top"><a class="brand-wrap" href="page-dashboard.html"><img class="logo"
          src="assets/imgs/theme/favicon.svg" alt="Evara Dashboard"></a>
      <div>
        <button class="btn btn-icon btn-aside-minimize"><i class="text-muted material-icons md-menu_open"></i></button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item"><a class="menu-link" href="page-dashboard.html"><i
              class="icon material-icons md-home"></i><span class="text">Dashboard</span></a></li>
        <li class="menu-item active"><a class="menu-link" href="page-products-list.html"><i
              class="icon material-icons md-shopping_bag"></i><span class="text">Products</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-orders.html"><i
              class="icon material-icons md-shopping_cart"></i><span class="text">Orders</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-sellers-list.html"><i
              class="icon material-icons md-store"></i><span class="text">Wholesellers</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-account-register.html"><i
              class="icon material-icons md-person"></i><span class="text">Create Moderator</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-web-customization.html"><i
              class="icon material-icons md-pie_chart"></i><span class="text">Customization</span></a></li>
      </ul>
      <hr>
      <ul class="menu-aside">
        <li class="menu-item"><a class="menu-link" href="page-settings.html"><i
              class="icon material-icons md-settings"></i><span class="text">Settings</span></a></li>
      </ul>
    </nav>
  </aside>
  <main class="main-wrap">
    <header class="main-header navbar">
      <div class="col-search"></div>
      <div class="col-nav">
        <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"><i
            class="material-icons md-apps"></i></button>
        <ul class="nav">
          <li class="nav-item"><a class="nav-link btn-icon" href="#"><i
                class="material-icons md-notifications animation-shake"></i><span class="badge rounded-pill"
                id="notification-badge">0</span></a></li>
          <li class="nav-item"><a class="nav-link btn-icon darkmode" href="#"><i
                class="material-icons md-nights_stay"></i></a></li>
          <li class="nav-item"><a class="requestfullscreen nav-link btn-icon" href="#"><i
                class="material-icons md-cast"></i></a></li>
          <li class="nav-item"><a class="dropdown-toggle" id="dropdownAccount" data-bs-toggle="dropdown" href="#"
              aria-expanded="false"><img class="img-xs rounded-circle" id="profile-pic"
                src="assets/imgs/people/avatar2.jpg" alt="User"></a>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
              <a class="dropdown-item text-danger" onclick="adminOutUser()"><i
                  class="material-icons md-exit_to_app"></i>Logout</a>
            </div>
          </li>
        </ul>
      </div>
    </header>
    <section class="content-main">
      <div class="row">
        <div class="col-9">
          <div class="content-header">
            <h2 class="content-title">Add New Product</h2>
            <div>
              <button onclick="addProduct('false',event)"
                class="btn btn-light rounded font-sm mr-5 text-body hover-up">Save to draft</button>
              <button onclick="addProduct('true',event)" class="btn btn-md rounded font-sm hover-up">Publish</button>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card mb-4">
            <div class="card-body">
              <div class="mb-4">
                <label class="form-label" for="product_title">Product title <span class="text-danger">*</span></label>
                <input class="form-control" id="product_title" type="text" placeholder="Enter the product name">
              </div>
              <div class="row gx-3">
                <div class="col-md-4 mb-3">
                  <label class="form-label" for="product_stock">Stock <span class="text-danger">*</span></label>
                  <input class="form-control" id="product_stock" type="number" placeholder="Enter the product stock">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label" for="product_type">Type </label>
                  <input class="form-control" id="product_type" type="text" placeholder="e.g(Cover,Cable,etc)">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label" for="product_sku">SKU </label>
                  <input class="form-control" id="product_sku" type="text" placeholder="Digit scan code">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label" for="product_weight">Weight </label>
                  <input class="form-control" id="product_weight" type="text" placeholder="0.240 kg">
                </div>
                <div class="col-md-8 mb-3">
                  <label class="form-label" for="product_dimensions">Dimensions </label>
                  <input class="form-control" id="product_dimensions" type="text" placeholder="0.74 x 7.64 x 16.08 cm">
                </div>
              </div>
              <div class="mb-4">
                <label class="form-label" for="product_delivery">Delivery Info </label>
                <textarea class="form-control" id="product_delivery"
                  placeholder="Available for all locations.&#10;Delivery Options &amp; Info" rows="3"></textarea>
              </div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div>
                <label class="form-label">Features <span class="text-danger">*</span></label>
                <input class="form-control input-field" id="product_features" data-type="feature" type="text"
                  placeholder="Type here and press enter 3 to 6(e.g transparent or flexible etc)">
              </div>
              <div id="entered_feature" class="entered-items"></div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div>
                <label class="form-label">Styles <span class="text-danger">*</span></label>
                <input class="form-control input-field" id="product_styles" data-type="style" type="text"
                  placeholder="Type here and press enter 3 to 6(e.g plain or printed etc)">
              </div>
              <div id="entered_style" class="entered-items"></div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div>
                <label class="form-label">Sizes <span class="text-danger">*</span></label>
                <input class="form-control input-field" id="product_sizes" data-type="size" type="text"
                  placeholder="Type here and press enter 3 to 6(e.g 5 6 7 8 etc)">
              </div>
              <div id="entered_size" class="entered-items"></div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div>
                <label class="form-label">Description <span class="text-danger">*</span></label>
                <textarea class="form-control" id="product_description" placeholder="Enter product description here"
                  rows="4"></textarea>
              </div>
            </div>
          </div>
          <div class="card mb-4">
            <div class="card-body">
              <form id="productForm">
                <div class="row gx-2">
                  <div class="col-md-6 mb-3">
                    <label class="form-label" for="product_spec_type">Type</label>
                    <input class="form-control product-type" type="text" placeholder="Brand, size, finish etc">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label" for="product_spec_value">Value <span class="text-danger">*</span></label>
                    <input class="form-control product-value" type="text" placeholder="Iphone, 5.8, pacific blue etc">
                  </div>

                  <div class="form-row" id="additionalInputs">
                    <!-- Additional input fields will be dynamically added here -->
                  </div>
                  <div class="col-md-12 text-center">
                    <button type="button" class="btn btn-primary" id="addProduct">Add More</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div class="row gx-2 color-section">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Color <span class="text-danger">*</span></label>
                  <input class="form-control" id="product_color" type="text" placeholder="Enter Product Color">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Images <span class="text-danger">*</span></label>
                  <div class="image-input-container">
                    <input class="form-control image-input" type="file" accept="image/*">
                  </div>
                </div>
              </div>
              <div class="mt-3 text-center">
                <button class="btn btn-primary add-more-colors-btn add-image-input">Add New Varient</button>
              </div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div class="product-images-section">
                <label class="form-label">Product Images <span class="text-danger">*</span></label>
                <div class="image-inputs mt-3">
                  <div class="image-input-container">
                    <input class="form-control product-image-input" type="file" accept="image/*">
                  </div>
                </div>
                <div class="mt-3 text-center">
                  <button class="btn btn-primary add-more-product-images-btn">Add More Images</button>
                </div>
              </div>
            </div>
          </div>


        </div>
        <div class="col-lg-3">
          <div class="card mb-4">
            <div class="card-header">
              <h4>Feature Image</h4>
            </div>
            <div class="card-body">
              <div class="input-upload"><img src="assets/imgs/theme/upload.svg" alt="">
                <div class="image-input-container">
                  <input class="form-control image-input feature-image-input" type="file" accept="image/*">
                </div>
              </div>
            </div>
          </div>
          <div class="card mb-4">
            <div class="card-body">
              <div class="mb-4">
                <label class="form-label">Price <span class="text-danger">*</span></label>
                <input class="form-control" id="product_price" type="number" placeholder="Type here">
              </div>
              <div class="mb-4">
                <label class="form-label">Discount % <span class="text-danger">*</span></label>
                <input class="form-control" id="product_discount" type="number" placeholder="Type here">
              </div>
              <div class="mb-4">
                <label class="form-label">Wholesale Price <span class="text-danger">*</span></label>
                <input class="form-control" id="product_wholesale_price" type="number" placeholder="Type here">
              </div>
              <div class="mb-4">
                <label class="form-label">Wholesale Discount % <span class="text-danger">*</span></label>
                <input class="form-control" id="product_wholesale_discount" type="number" placeholder="Type here">
              </div>
              <div class="mb-4">
                <label class="form-label">Tags <span class="text-danger">*</span></label>
                <input class="form-control" id="tag_input" type="text" placeholder="Type here">
              </div>
              <div id="tag_list"></div>
              <hr>
              <div class="row gx-2">
                <div class="col-sm-6 mb-3">
                  <label class="form-label">Category <span class="text-danger">*</span></label>
                  <select class="form-select" id="categorySelect">
                    <option value="">Loading...</option>
                  </select>
                </div>
                <div class="col-sm-6 mb-3">
                  <label class="form-label">Sub-category <span class="text-danger">*</span></label>
                  <select class="form-select" id="subCategorySelect">
                    <!-- Options will be dynamically populated based on the selected category -->
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <footer class="main-footer font-xs">
      <div class="row pb-30 pt-15">
        <div class="col-sm-6">
          Copyright &copy;
          <script>document.write(new Date().getFullYear())</script> , ibest.
        </div>
        <div class="col-sm-6">
          <div class="text-sm-end">All rights reserved</div>
        </div>
      </div>
    </footer>
  </main>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="assets/js/vendors/bootstrap.bundle.min.js"></script>
  <script src="assets/js/vendors/select2.min.js"></script>
  <script src="assets/js/vendors/perfect-scrollbar.js"></script>
  <script src="assets/js/vendors/jquery.fullscreen.min.js"></script>
  <script src="assets/js/vendors/chart.js"></script>
  <script src="assets/js/main.js?v=1.0.0"></script>
  <script src="assets/js/custom-chart.js" type="text/javascript"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAKUrhFJiaHhFlqu0w3zKTyhIgXJNIIg68",
      authDomain: "ibest-ba2cf.firebaseapp.com",
      projectId: "ibest-ba2cf",
      storageBucket: "ibest-ba2cf.appspot.com",
      messagingSenderId: "946876798909",
      appId: "1:946876798909:web:b40bc879e556a26cafe4d4",
      measurementId: "G-QYR88B09WG"
    };
    firebase.initializeApp(firebaseConfig);

    var firestore = firebase.firestore();
    var auth = firebase.auth();
    var storage = firebase.storage();
    var storageRef = storage.ref();

    function showAlert(text) {
      Swal.fire({
        title: text,
        showClass: {
          popup: `
            animate__animated
            animate__fadeInUp
            animate__faster
          `
        },
        hideClass: {
          popup: `
            animate__animated
            animate__fadeOutDown
            animate__faster
          `
        },
        confirmButtonColor: '#BF141F',
        customClass: {
          title: 'alertClass',
          popup: 'alertClassPopup'
        }
      });
    }

    function showAlertWithNav(text, href) {
      Swal.fire({
        title: text,
        showClass: {
          popup: `
            animate__animated
            animate__fadeInUp
            animate__faster
          `
        },
        hideClass: {
          popup: `
            animate__animated
            animate__fadeOutDown
            animate__faster
          `
        },
        confirmButtonColor: '#BF141F',
        customClass: {
          title: 'alertClass',
          popup: 'alertClassPopup'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = href;
        }
      });
    }

    $(document).ready(function () {
      // Event delegation for "Add More Colors" button
      $(document).on('click', '.add-more-colors-btn', function () {
        let colorSection = $('.color-section').first().clone(true);
        colorSection.find('.selected-color').text('');
        colorSection.find('.image-input-container').empty(); // Clear existing image input
        colorSection.find('.image-input-container').append('<input class="form-control image-input" type="file" accept="image/*">'); // Add new image input
        colorSection.insertAfter($('.color-section').last());
      });

      // Event delegation for "Add More Images" button
      $(document).on('click', '.add-more-product-images-btn', function () {
        var imageInputs = document.querySelectorAll('.product-images-section .image-input-container');
        var newImageInputContainer = imageInputs[imageInputs.length - 1].cloneNode(true);
        document.querySelector('.product-images-section .image-inputs').appendChild(newImageInputContainer);
      });


      // Event delegation for color selection change
      $(document).on('change', '.color-select', function () {
        let color = $(this).val();
        $(this).closest('.color-section').find('.selected-color').text(color);
      });




      // Function to handle adding items
      function addItem(itemType, item) {
        $('#entered_' + itemType).append('<div class="' + itemType + '-item"><span>' + item + '</span><i class="font-xs material-icons md-close text-body remove-item" data-type="' + itemType + '"></i></div>');
      }

      // Event listener for Enter key press in the input field for features, styles, and sizes
      $('.input-field').keypress(function (event) {
        if (event.which === 13) { // Check if Enter key is pressed
          event.preventDefault(); // Prevent default Enter key behavior (e.g., form submission)
          let itemType = $(this).data('type'); // Get the type of item (feature, style, or size)
          let item = $(this).val().trim(); // Get the entered item value
          if (item !== '') { // Check if the entered item is not empty
            addItem(itemType, item); // Add the item
            $(this).val(''); // Clear the input field
          }
        }
      });

      // Event delegation for removing items
      $(document).on('click', '.remove-item', function () {
        $(this).closest('.' + $(this).data('type') + '-item').remove(); // Remove the item containing the clicked cross sign
      });


      // Function to handle adding tags
      function addTag(tag) {
        $('#tag_list').append('<div class="tag-item"><span>' + tag + '</span><i class="font-xs material-icons md-close text-body remove-tag"></i></div>');
      }

      // Event listener for Enter key press in the tag input field
      $('#tag_input').keypress(function (event) {
        if (event.which === 13) { // Check if Enter key is pressed
          event.preventDefault(); // Prevent default Enter key behavior (e.g., form submission)
          let tag = $(this).val().trim(); // Get the entered tag value
          if (tag !== '') { // Check if the entered tag is not empty
            addTag(tag); // Add the tag
            $(this).val(''); // Clear the input field
          }
        }
      });

      // Event delegation for removing tags
      $(document).on('click', '.remove-tag', function () {
        $(this).closest('.tag-item').remove(); // Remove the tag item containing the clicked close icon
      });
    });

    // Function to fetch categories and sub-categories from Firestore
    async function fetchCategoriesAndSubCategories() {
      try {
        const categoriesSnapshot = await firestore.collection('categories').get();

        const categories = {};
        categoriesSnapshot.forEach(categoryDoc => {
          const categoryName = categoryDoc.id;
          const subCategories = categoryDoc.data().subCategories;
          categories[categoryName] = subCategories;
        });

        return categories;
      } catch (error) {
        console.error("Error fetching categories and sub-categories:", error);
        return {};
      }
    }

    // Function to populate category select element
    async function populateCategorySelect() {
      const categorySelect = document.getElementById('categorySelect');
      const categories = await fetchCategoriesAndSubCategories();

      // Clear existing options
      categorySelect.innerHTML = '';

      // Populate with fetched categories
      for (const categoryName in categories) {
        const option = document.createElement('option');
        option.value = categoryName;
        option.text = categoryName;
        categorySelect.add(option);
      }

      // Trigger change event to populate sub-categories for the initial selected category
      categorySelect.dispatchEvent(new Event('change'));
    }

    // Function to populate sub-category select based on the selected category
    async function populateSubCategories() {
      const categorySelect = document.getElementById('categorySelect');
      const subCategorySelect = document.getElementById('subCategorySelect');
      const selectedCategory = categorySelect.value;
      const categories = await fetchCategoriesAndSubCategories();

      // Clear existing options
      subCategorySelect.innerHTML = '';

      // Populate with sub-categories for the selected category
      categories[selectedCategory].forEach(subCategory => {
        const option = document.createElement('option');
        option.text = subCategory;
        subCategorySelect.add(option);
      });
    }

    // Listen for changes in the category select element
    document.getElementById('categorySelect').addEventListener('change', populateSubCategories);

    // Initial population when page loads
    populateCategorySelect();

    // Function to add more type and value inputs
    function addMoreInputs() {
      const additionalInputs = document.getElementById('additionalInputs');

      // Create new row for type and value inputs
      const newRow = document.createElement('div');
      newRow.classList.add('row', 'gx-2');

      // Create new type input
      const newTypeInput = document.createElement('div');
      newTypeInput.classList.add('col-md-6', 'mb-3');
      newTypeInput.innerHTML = `
    <input class="form-control product-type" type="text" placeholder="Brand, size, finish etc">
  `;

      // Create new value input
      const newValueInput = document.createElement('div');
      newValueInput.classList.add('col-md-6', 'mb-3');
      newValueInput.innerHTML = `
    <input class="form-control product-value" type="text" placeholder="Iphone, 5.8, pacific blue etc">
  `;

      // Append type and value inputs to the new row
      newRow.appendChild(newTypeInput);
      newRow.appendChild(newValueInput);

      // Append new row to the additionalInputs container
      additionalInputs.appendChild(newRow);
    }

    // Event listener for adding more inputs
    document.getElementById('addProduct').addEventListener('click', addMoreInputs);


    function addProduct(publish) {
      event.preventDefault();
      var price = document.getElementById('product_price').value;
      var wholsalePrice = document.getElementById('product_wholesale_price').value;
      var wholesaleDiscount = document.getElementById('product_wholesale_discount').value;
      var sku = document.getElementById('product_sku').value;
      var discount = document.getElementById('product_discount').value;
      var product = document.getElementById('product_title').value;
      var weight = document.getElementById('product_weight').value;
      var stock = document.getElementById('product_stock').value;
      var dimensions = document.getElementById('product_dimensions').value;
      var type = document.getElementById('product_type').value;
      var Delivery = document.getElementById('product_delivery').value;
      var description = document.getElementById('product_description').value;
      var colorSections = document.querySelectorAll('.color-section');
      const categorySelect = document.getElementById('categorySelect');
      const selectedCategoryOption = categorySelect.options[categorySelect.selectedIndex];
      const selectedCategory = selectedCategoryOption.text;
      const selectedSubCategorie = document.getElementById('subCategorySelect').value;
      const types = [];
      const values = [];
      let features = [];
      let styles = [];
      let sizes = [];

      document.querySelectorAll('.product-type').forEach(input => types.push(input.value));
      document.querySelectorAll('.product-value').forEach(input => values.push(input.value));

      $('#entered_feature .feature-item span').each(function () {
        features.push($(this).text());
      });

      $('#entered_style .style-item span').each(function () {
        styles.push($(this).text());
      });

      $('#entered_size .size-item span').each(function () {
        sizes.push($(this).text());
      });

      // Display collected data on console
      console.log("Features:", features);
      console.log("Styles:", styles);
      console.log("Sizes:", sizes);
      console.log("Selected Category:", selectedCategory);
      console.log("Selected Sub-category:", selectedSubCategorie);
      console.log('Types:', types);
      console.log('Values:', values);

      // Get tags
      var tags = [];
      document.querySelectorAll('#tag_list .tag-item span').forEach(function (tag) {
        tags.push(tag.textContent);
      });


      // Prepare data object for Firestore
      // add sku delivery info and add one pic with each color
      var data = {
        price: price,
        discount: discount,
        deliveryInfo: Delivery,
        wholsalePrice: wholsalePrice,
        wholesaleDiscount: wholesaleDiscount,
        sku: sku,
        product: product,
        stock: stock,
        remainingStock: stock,
        Type: type,
        publish: publish,
        description: description,
        features: features,
        styles: styles,
        sizes: sizes,
        tags: tags,
        type: types,
        value: values,
        weight: weight,
        dimensions,
        selectedCategory: selectedCategory,
        selectedSubCategorie: selectedSubCategorie,
        colors: [],
        featureImageUrl: {},
        productImages: [],
        registeredDate: new Date(),
      };

      var featureImageInput = document.querySelector('.feature-image-input');
      var featureImageFile = featureImageInput.files[0];
      var featureImagePromise = null;

      // Upload feature image to Firebase Storage if featureImageInput exists and feature image is selected
      if (featureImageFile) {
        var featureImageName = 'feature_image_' + Date.now();
        var featureImageRef = storageRef.child('images/' + featureImageName);
        var featureUploadTask = featureImageRef.put(featureImageFile);
        featureImagePromise = new Promise(function (resolve, reject) {
          featureUploadTask.then(function (snapshot) {
            featureImageRef.getDownloadURL().then(function (downloadURL) {
              resolve(downloadURL);
            }).catch(function (error) {
              reject(error);
            });
          }).catch(function (error) {
            reject(error);
          });
        });
      }

      // Prepare product images data
      var productImagePromises = [];
      var productImageInputs = document.querySelectorAll('.product-image-input');
      productImageInputs.forEach(function (imageInput) {
        var imageFile = imageInput.files[0];
        if (imageFile) {
          var imageName = 'product_image_' + Date.now() + '_' + Math.random();
          var imageRef = storageRef.child('images/' + imageName);
          var uploadTask = imageRef.put(imageFile);
          var uploadPromise = new Promise(function (resolve, reject) {
            uploadTask.then(function (snapshot) {
              imageRef.getDownloadURL().then(function (downloadURL) {
                resolve(downloadURL);
              }).catch(function (error) {
                reject(error);
              });
            }).catch(function (error) {
              reject(error);
            });
          });
          productImagePromises.push(uploadPromise);
        }
      });

      // Prepare color data
      var colorPromises = [];
      colorSections.forEach(function (colorSection, index) {
        var color = colorSection.querySelector('.form-control#product_color').value;
        var firstImageInput = colorSection.querySelector('.image-input-container input[type="file"]');
        var firstImageFile = firstImageInput.files[0];

        if (firstImageFile) {
          var imageName = 'image_' + Date.now() + '_' + Math.random();
          var imageRef = storageRef.child('images/' + imageName);
          var uploadTask = imageRef.put(firstImageFile);

          var uploadPromise = new Promise(function (resolve, reject) {
            uploadTask.then(function (snapshot) {
              imageRef.getDownloadURL().then(function (downloadURL) {
                resolve(downloadURL);
              }).catch(function (error) {
                reject(error);
              });
            }).catch(function (error) {
              reject(error);
            });
          });

          colorPromises.push(uploadPromise.then(function (imageUrl) {
            return { color: color, imageUrl: imageUrl };
          }));
        }
      });

      // Combine all image upload promises
      var allImagePromises = [featureImagePromise, ...colorPromises, ...productImagePromises];

      // Wait for all image uploads to complete
      Promise.all(allImagePromises).then(function (values) {
        var featureImageUrl = values.shift(); // Remove the first value which is the feature image URL
        data.featureImageUrl = featureImageUrl;
        data.colors = values.slice(0, colorPromises.length); // Extract color data
        data.productImages = values.slice(colorPromises.length); // Extract product image URLs
        console.log("Feature Image URL:", data.featureImageUrl);
        console.log("Colors:", data.colors);
        console.log("Product Images:", data.productImages);

        // Save the data to Firestore
        saveDataToFirestore(data);
      }).catch(function (error) {
        console.error('Error:', error);
      });

      // Function to save data to Firestore
      function saveDataToFirestore(data) {
        // Generate a unique document ID
        var docId = firestore.collection("products").doc().id;

        var docRef = firestore.collection("products").doc(selectedCategory).collection(selectedSubCategorie).doc(docId);
        var docRefAll = firestore.collection("products").doc(selectedCategory).collection('All').doc(docId);
        var docRefCategory = firestore.collection("categories").doc(data.selectedCategory);

        // Add the data to the document
        docRef.set(data)
          .then(function () {
            console.log("Document added to subcategory '" + selectedSubCategorie + "' with ID '" + docId + "'.");
          })
          .catch(function (error) {
            console.error("Error adding document to subcategory '" + selectedSubCategorie + "': ", error);
          });

        // Add the data to the document
        docRefAll.set(data)
          .then(function () {
            console.log("Document added to subcategory All with ID " + docId + "'.");

          })
          .catch(function (error) {
            console.error("Error adding document to subcategory All", error);
          });


        // Update productsNo field by incrementing it
        docRefCategory.update({
          ProductsNo: firebase.firestore.FieldValue.increment(1)
        })
          .then(() => {
            console.log("productsNo field updated successfully!");
            showAlertWithNav("Products Added to Category successfully!", "page-add-product.html");
          })
          .catch((error) => {
            console.error("Error updating productsNo field: ", error);
          });

      }
    }

    var count = 0;

    function fetchOrders() {
      const ordersCollectionRef = firebase.firestore().collection('users');
      ordersCollectionRef.get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          userData.orders.forEach((order) => {
            if (order.viewed === false) {
              count++;
            }
          });
        });
        var badge = document.getElementById("notification-badge");
        badge.textContent = count;
      }).catch((error) => {
        console.log("Error fetching order notification.");
      });
    }

    fetchOrders();

    // Function to sign out the admin
    function adminOutUser() {
      firebase.auth().signOut().then(function () {
        console.log('admin signed out successfully');
        showAlertWithNav('Admin signed out successfully!', 'index.html');
      }).catch(function (error) {
        console.error('Error signing out:', error);
      });
    }

    // Function to fetch user data when the authentication state changes
    function onAuthStateChanged(user) {
      if (user) {
        fetchUserData();
      } else {
        console.log("No user is signed in.");
      }
    }
    firebase.auth().onAuthStateChanged(onAuthStateChanged);

    function fetchUserData() {
      var user = firebase.auth().currentUser;
      if (user) {
        var userId = user.uid;
        var userDocRef = firestore.collection("admins").doc(userId);

        userDocRef.get().then(function (doc) {
          if (doc.exists) {
            const data = doc.data();
            if (data.profilePicUrl) {
              var imageElement = document.getElementById("profile-pic");
              imageElement.src = data.profilePicUrl;
            }
          } else {
            console.log("No user data found for current user.");
          }
        }).catch(function (error) {
          console.error("Error getting user document:", error);
        });
      } else {
        console.log("No user is signed in.");
      }
    }
  </script>
</body>

</html>