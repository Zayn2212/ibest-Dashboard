<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <link rel="shortcut icon" type="image/x-icon" href="assets/imgs/theme/favicon.svg">
  <link href="assets/css/style.css?v=1.0.0" rel="stylesheet">
  <title>ibest - Setting</title>
</head>

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <link rel="shortcut icon" type="image/x-icon" href="assets/imgs/theme/favicon.svg">
  <link href="assets/css/style.css?v=1.0.0" rel="stylesheet">
  <title>ibest - Setting</title>
</head>

<body>
  <div id="preloader-active">
    <div class="preloader d-flex align-items-center justify-content-center">
      <div class="preloader-inner position-relative">
        <div class="text-center"><img class="mb-10" src="assets/imgs/theme/favicon.svg" alt="ibest">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="screen-overlay"></div>
  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top"><a class="brand-wrap" href="page-dashboard.html"><img class="logo"
          src="assets/imgs/theme/favicon.svg" alt="Evara Dashboard"></a>
      <div>
        <button class="btn btn-icon btn-aside-minimize"><i class="text-muted material-icons md-menu_open"></i></button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item"><a class="menu-link" href="page-dashboard.html"><i
              class="icon material-icons md-home"></i><span class="text">Dashboard</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-products-list.html"><i
              class="icon material-icons md-shopping_bag"></i><span class="text">Products</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-orders.html"><i
              class="icon material-icons md-shopping_cart"></i><span class="text">Orders</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-sellers-list.html"><i
              class="icon material-icons md-store"></i><span class="text">Wholesellers</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-account-register.html"><i
              class="icon material-icons md-person"></i><span class="text">Create Moderator</span></a></li>
        <li class="menu-item"><a class="menu-link" href="page-web-customization.html"><i
              class="icon material-icons md-pie_chart"></i><span class="text">Customization</span></a></li>
      </ul>
      <hr>
      <ul class="menu-aside">
        <li class="menu-item active"><a class="menu-link" href="page-settings.html"><i
              class="icon material-icons md-settings"></i><span class="text">Settings</span></a></li>
      </ul>
    </nav>
  </aside>
  <main class="main-wrap">
    <header class="main-header navbar">
      <div class="col-search"></div>
      <div class="col-nav">
        <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"><i
            class="material-icons md-apps"></i></button>
        <ul class="nav">
          <li class="nav-item"><a class="nav-link btn-icon" href="#"><i
                class="material-icons md-notifications animation-shake"></i><span class="badge rounded-pill"
                id="notification-badge">0</span></a></li>
          <li class="nav-item"><a class="nav-link btn-icon darkmode" href="#"><i
                class="material-icons md-nights_stay"></i></a></li>
          <li class="nav-item"><a class="requestfullscreen nav-link btn-icon" href="#"><i
                class="material-icons md-cast"></i></a></li>
          <li class="nav-item"><a class="dropdown-toggle" id="dropdownAccount" data-bs-toggle="dropdown" href="#"
              aria-expanded="false"><img class="img-xs rounded-circle" id="profile-pic" src="assets/imgs/people/avatar2.jpg"
                alt="User"></a>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
              <a class="dropdown-item text-danger" onclick="adminOutUser()"><i
                  class="material-icons md-exit_to_app"></i>Logout</a>
            </div>
          </li>
        </ul>
      </div>
    </header>
    <section class="content-main">
      <div class="content-header">
        <h2 class="content-title">Profile setting</h2>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="row gx-5">

            <div class="col-lg-9">
              <section class="content-body p-xl-4">
                <form id="myForm">
                  <div class="row">
                    <div class="col-lg-8">
                      <div class="row gx-3">
                        <div class="col-6 mb-3">
                          <label class="form-label">First name</label>
                          <input class="form-control" id="firstName" type="text" placeholder="Type here">
                        </div>
                        <!-- col .//-->
                        <div class="col-6 mb-3">
                          <label class="form-label">Last name</label>
                          <input class="form-control" id="lastName" type="text" placeholder="Type here">
                        </div>
                        <!-- col .//-->
                        <div class="col-lg-6 mb-3">
                          <label class="form-label">Email</label>
                          <input class="form-control" id="email" type="email" placeholder="example@mail.com">
                        </div>
                        <!-- col .//-->
                        <div class="col-lg-6 mb-3">
                          <label class="form-label">Phone</label>
                          <input class="form-control" id="phone" type="tel" placeholder="+1234567890">
                        </div>
                        <!-- col .//-->
                        <div class="col-lg-12 mb-3">
                          <label class="form-label">Address</label>
                          <input class="form-control" id="address" type="text" placeholder="Type here">
                        </div>
                        <!-- col .//-->
                        <div class="col-lg-6 mb-3">
                          <label class="form-label">Birthday</label>
                          <input class="form-control" id="birthday" type="date">
                        </div>
                        <!-- col .//-->
                        <!-- row.//-->
                        <!-- col.//-->
                      </div>
                    </div>
                    <aside class="col-lg-4">
                      <figure class="text-lg-center">
                        <!-- Input for uploading an image -->
                        <input type="file" accept="image/*" id="profile-picture-input" style="display: none;">
                        <label for="profile-picture-input">
                          <img class="img-lg mb-3 img-avatar" id="profile-picture-preview"
                            src="assets/imgs/people/avatar1.jpg" alt="User Photo">
                          <figcaption>
                            <!-- Add an ID to the "Upload" button -->
                            <a onclick="uploadPicture()" id="upload-button" class="btn btn-light rounded font-md"
                              href="#">
                              <i class="icons material-icons md-backup font-md"></i> Upload
                            </a>
                          </figcaption>
                        </label>
                      </figure>
                    </aside>


                    <!-- col.//-->
                    <!-- row.//-->
                  </div><br>
                  <button class="btn btn-primary" type="submit">Save changes</button>
                </form>
                <!--<hr class="my-5">
                  <div class="row" style="max-width:920px">
                    <div class="col-md">
                      <article class="box mb-3 bg-light"><a class="btn float-end btn-light btn-sm rounded font-md" href="#">Change</a>
                        <h6>Password</h6><small class="text-muted d-block" style="width:70%">You can reset or change your password by clicking here</small>
                      </article>
                    </div>
                    <div class="col-md">
                      <article class="box mb-3 bg-light"><a class="btn float-end btn-light rounded btn-sm font-md" href="#">Deactivate</a>
                        <h6>Remove account</h6><small class="text-muted d-block" style="width:70%">Once you delete your account, there is no going back.</small>
                      </article>
                    </div>-->
                <!-- col.//-->
                <!-- row.//-->
                <!-- content-body .//-->
                <!-- col.//-->
                <!-- row.//-->
                <!-- card body end//-->
            </div>
    </section>
    </div>
    </div>
    </div>
    </div>
    </section>
    <footer class="main-footer font-xs">
      <div class="row pb-30 pt-15">
        <div class="col-sm-6">
          <script>document.write(new Date().getFullYear())</script> &copy;, ibest .
        </div>
        <div class="col-sm-6">
          <div class="text-sm-end">All rights reserved</div>
        </div>
      </div>
    </footer>
  </main>
  <script src="assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="assets/js/vendors/bootstrap.bundle.min.js"></script>
  <script src="assets/js/vendors/select2.min.js"></script>
  <script src="assets/js/vendors/perfect-scrollbar.js"></script>
  <script src="assets/js/vendors/jquery.fullscreen.min.js"></script>
  <script src="assets/js/vendors/chart.js"></script>
  <script src="assets/js/main.js?v=1.0.0"></script>
  <script src="assets/js/custom-chart.js" type="text/javascript"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAKUrhFJiaHhFlqu0w3zKTyhIgXJNIIg68",
      authDomain: "ibest-ba2cf.firebaseapp.com",
      projectId: "ibest-ba2cf",
      storageBucket: "ibest-ba2cf.appspot.com",
      messagingSenderId: "946876798909",
      appId: "1:946876798909:web:b40bc879e556a26cafe4d4",
      measurementId: "G-QYR88B09WG"
    };
    firebase.initializeApp(firebaseConfig);
    var firestore = firebase.firestore();
    var auth = firebase.auth();
    var storage = firebase.storage();
    var storageRef = storage.ref();

    function showAlert(text) {
      Swal.fire({
        title: text,
        showClass: {
          popup: `
            animate__animated
            animate__fadeInUp
            animate__faster
          `
        },
        hideClass: {
          popup: `
            animate__animated
            animate__fadeOutDown
            animate__faster
          `
        },
        confirmButtonColor: '#BF141F',
        customClass: {
          title: 'alertClass',
          popup: 'alertClassPopup'
        }
      });
    }

    function showAlertWithNav(text,href) {
      Swal.fire({
        title: text,
        showClass: {
          popup: `
            animate__animated
            animate__fadeInUp
            animate__faster
          `
        },
        hideClass: {
          popup: `
            animate__animated
            animate__fadeOutDown
            animate__faster
          `
        },
        confirmButtonColor: '#BF141F',
        customClass: {
          title: 'alertClass',
          popup: 'alertClassPopup'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.replace(href);
        }
      });
    }


    var docId = {};
    var orderId = {};
    var status = {};
    var count = 0;

    // Function to handle file upload
    function handleFileUpload(event) {
      const selectedFile = event.target.files[0];
      const imgPreview = document.getElementById('profile-picture-preview');

      if (selectedFile) {
        const reader = new FileReader();

        reader.onload = function (event) {
          imgPreview.src = event.target.result;
        };

        reader.readAsDataURL(selectedFile);
      }
    }

    document.getElementById('profile-picture-input').addEventListener('change', handleFileUpload);


    function uploadPicture() {
      const fileInput = document.getElementById('profile-picture-input');
      const file = fileInput.files[0];

      // Check if a file is selected
      if (!file) {
        showAlert("Please select a picture by clicking on the image.");
        return;
      }

      // Get the current user
      const user = firebase.auth().currentUser;

      if (!user) {
        showAlert("No user is signed in.");
        return;
      }

      const storageRef = firebase.storage().ref();
      const fileRef = storageRef.child('profile_pictures/' + file.name);

      // Upload file to Firebase Storage
      fileRef.put(file)
        .then((snapshot) => {
          // Get the download URL of the uploaded file
          return fileRef.getDownloadURL();
        })
        .then((downloadURL) => {
          // Update only the profilePicUrl field in Firestore
          return firestore.collection("admins").doc(user.uid).update({
            profilePicUrl: downloadURL
          });
        })
        .then(() => {
          console.log("Profile picture URL updated successfully!");
          showAlertWithNav("Profile picture URL updated successfully!","page-settings.html");
        })
        .catch((error) => {
          console.error('Error uploading file:', error);
          showAlert("An error occurred while updating the profile picture URL. Please try again later.");
        });
    }

    // Function to handle form submission
    function handleSubmit(event) {
      event.preventDefault(); // Prevent the default form submission

      // Get input values
      var firstName = document.getElementById('firstName').value;
      var lastName = document.getElementById('lastName').value;
      var email = document.getElementById('email').value;
      var phone = document.getElementById('phone').value;
      var address = document.getElementById('address').value;
      var birthday = document.getElementById('birthday').value;

      // Log input values to the console
      console.log('First Name:', firstName);
      console.log('Last Name:', lastName);
      console.log('Email:', email);
      console.log('Phone:', phone);
      console.log('Address:', address);
      console.log('Birthday:', birthday);

      var info = {
        firstName: firstName,
        lastName: lastName,
        email: email,
        phoneNo: phone,
        address: address,
        birthday: birthday,
      };

      var user = firebase.auth().currentUser;
      if (user) {
        var userId = user.uid;
        var userDocRef = firestore.collection("admins").doc(userId);

        userDocRef.update({
          info,
        })
          .then(() => {
            showAlertWithNav("Successfully updated!","page-settings.html");
          })
          .catch((error) => {
            console.error("Error updating document: ", error);
          });

      } else {
        console.log("No user is signed in.");
      }
    }

    // Add event listener to form submit event
    document.getElementById('myForm').addEventListener('submit', handleSubmit);

    // Function to fetch user data when the authentication state changes
    function onAuthStateChanged(user) {
      if (user) {
        fetchUserData();
      } else {
        console.log("No user is signed in.");
      }
    }

    // Add a listener for authentication state changes
    firebase.auth().onAuthStateChanged(onAuthStateChanged);

    function fetchUserData() {
      var user = firebase.auth().currentUser;
      if (user) {
        var userId = user.uid;
        var userDocRef = firestore.collection("admins").doc(userId);

        userDocRef.get().then(function (doc) {
          if (doc.exists) {
            const data = doc.data();
            if (data.profilePicUrl) {
              var imageElement = document.getElementById("profile-picture-preview");
              imageElement.src = data.profilePicUrl;

              var imageElementPP = document.getElementById("profile-pic");
              imageElementPP.src = data.profilePicUrl;
            }
            if (data.info) {
              document.getElementById('firstName').value=data.info.firstName;
              document.getElementById('lastName').value=data.info.lastName;
              document.getElementById('email').value=data.info.email;
              document.getElementById('phone').value=data.info.phoneNo;
              document.getElementById('address').value=data.info.address;
              document.getElementById('birthday').value=data.info.birthday;
            }
          } else {
            // User document not found
            console.log("No user data found for current user.");
          }
        }).catch(function (error) {
          console.error("Error getting user document:", error);
        });
      } else {
        // No user is signed in
        console.log("No user is signed in.");
      }
    }

    function fetchOrders() {
      const ordersCollectionRef = firebase.firestore().collection('users');
      ordersCollectionRef.get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          userData.orders.forEach((order) => {
            if (order.viewed === false) {
              count++;
            }
          });
        });
        var badge = document.getElementById("notification-badge");
        badge.textContent = count;
      }).catch((error) => {
        console.log("Error fetching order notification.");
      });
    }

    fetchOrders();

    // Function to sign out the admin
    function adminOutUser() {
      firebase.auth().signOut().then(function () {
        console.log('admin signed out successfully');
        showAlertWithNav('Admin signed out successfully!','index.html');
      }).catch(function (error) {
        console.error('Error signing out:', error);
      });
    }

    
  </script>
</body>

</html>